name: Deploy VitePress site to Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn  # âœ… å¯ç”¨ Yarn ç¼“å­˜
          cache-dependency-path: docs/yarn.lock  # âœ… æŒ‡å‘ yarn.lock
      
      - name: Install dependencies
        working-directory: ./docs
        run: yarn install --frozen-lockfile  # âœ… Yarn å‘½ä»¤
      
      - name: Build with VitePress
        working-directory: ./docs
        run: yarn docs:build  # âœ… ä½¿ç”¨ yarn è€Œé npm
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs/.vitepress/dist

  deploy:
    environment:
      name: github-pages# .github/workflows/deploy.yml
name: Deploy VitePress site to Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # âœ… ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼ˆå¿…é¡»æœ€å…ˆæ‰§è¡Œï¼ï¼‰
      - name: Checkout
        uses: actions/checkout@v4
      
      # âœ… ç¬¬äºŒæ­¥ï¼šéªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè°ƒè¯•ç”¨ï¼ŒæˆåŠŸåå¯ä¿ç•™ï¼‰
      - name: ğŸ” Verify package-lock.json exists
        run: |
          if [ ! -f "docs/package-lock.json" ]; then
            echo "âŒ CRITICAL ERROR: docs/package-lock.json NOT FOUND!"
            echo "Check your repository: https://github.com/cjz-wr/DesktopByAi-Document/tree/main/docs"
            exit 1
          fi
          echo "âœ… Found docs/package-lock.json (size: $(stat -c%s docs/package-lock.json) bytes)"
      
      # âœ… ç¬¬ä¸‰æ­¥ï¼šè®¾ç½® Node.jsï¼ˆæ­¤æ—¶ä»£ç å·²å­˜åœ¨ï¼Œç¼“å­˜è·¯å¾„æœ‰æ•ˆï¼‰
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm  # âœ… å…³é”®ï¼šä½¿ç”¨ npm ç¼“å­˜
          cache-dependency-path: docs/package-lock.json  # âœ… æŒ‡å‘æ­£ç¡®æ–‡ä»¶
      
      # âœ… ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–ï¼ˆåœ¨ docs ç›®å½•ï¼‰
      - name: Install dependencies
        working-directory: ./docs
        run: npm ci  # âœ… ä½¿ç”¨ npm ciï¼ˆä¾èµ– package-lock.jsonï¼‰
      
      # âœ… ç¬¬äº”æ­¥ï¼šæ„å»ºé¡¹ç›®
      - name: Build with VitePress
        working-directory: ./docs
        run: npm run docs:build
      
      # âœ… ç¬¬å…­æ­¥ï¼šéªŒè¯æ„å»ºäº§ç‰©
      - name: ğŸ” Verify build output
        run: |
          if [ ! -f "docs/.vitepress/dist/index.html" ]; then
            echo "âŒ Build failed: index.html not found!"
            exit 1
          fi
          echo "âœ… Build successful! Found index.html"
      
      # âœ… ç¬¬ä¸ƒæ­¥ï¼šé…ç½® Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      # âœ… ç¬¬å…«æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs/.vitepress/dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4